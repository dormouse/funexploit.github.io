<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>linux驱动开发笔记 &mdash; funexploit 1.0 documentation</title>
    
    <link rel="stylesheet" href="../static/default.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <link rel="top" title="funexploit 1.0 documentation" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../index.html">funexploit 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="linux">
<h1><a class="toc-backref" href="#id23">linux驱动开发笔记</a><a class="headerlink" href="#linux" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#linux" id="id23">linux驱动开发笔记</a><ul>
<li><a class="reference internal" href="#id1" id="id24">开发环境搭建</a><ul>
<li><a class="reference internal" href="#id2" id="id25">根文件系统构建</a><ul>
<li><a class="reference internal" href="#busybox" id="id26">busybox</a></li>
<li><a class="reference internal" href="#id3" id="id27">根文件系统其它必须文件</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id4" id="id28">遇到的疑难杂症</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id5" id="id29">概述</a><ul>
<li><a class="reference internal" href="#id6" id="id30">驱动底层封装接口</a></li>
<li><a class="reference internal" href="#id7" id="id31">驱动程序结构</a></li>
<li><a class="reference internal" href="#id8" id="id32">主要文件介绍</a></li>
<li><a class="reference internal" href="#id9" id="id33">其他</a></li>
<li><a class="reference internal" href="#id10" id="id34">应用层辅助工具</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id11" id="id35">设备驱动模型及子系统</a><ul>
<li><a class="reference internal" href="#bus-device-driver" id="id36">bus-device-driver 设备驱动模型</a></li>
<li><a class="reference internal" href="#platform" id="id37">Platform 虚拟总线</a></li>
<li><a class="reference internal" href="#id12" id="id38">输入子系统</a></li>
<li><a class="reference internal" href="#framebuffer" id="id39">视频子系统(framebuffer)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id13" id="id40">内核机制</a><ul>
<li><a class="reference internal" href="#id14" id="id41">并发控制( 信号量、自旋锁)</a></li>
<li><a class="reference internal" href="#id15" id="id42">内核定时器</a></li>
<li><a class="reference internal" href="#id16" id="id43">休眠与唤醒</a></li>
<li><a class="reference internal" href="#id17" id="id44">中断</a></li>
<li><a class="reference internal" href="#id18" id="id45">异步通知</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id19" id="id46">硬件设备驱动程序开发</a><ul>
<li><a class="reference internal" href="#id20" id="id47">串口</a><ul>
<li><a class="reference internal" href="#id21" id="id48">主要的数据结构</a></li>
<li><a class="reference internal" href="#id22" id="id49">主要的操作</a></li>
</ul>
</li>
<li><a class="reference internal" href="#nand-flash" id="id50">Nand Flash</a></li>
<li><a class="reference internal" href="#usb" id="id51">USB</a></li>
<li><a class="reference internal" href="#network" id="id52">Network</a><ul>
<li><a class="reference internal" href="#lcd" id="id53">LCD硬件相关</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p>为了学习linux驱动和内核的开发，买了块友善tiny6410的板子，开始了嵌入式系统的学习。本文是我在学习过程中的笔记，会随着自己的学习持续更新，文章如有错误，敬请指正。</p>
<p>另外寻求有兴趣的朋友一起学习折腾、实时交流心得体会和问题。 <a class="reference external" href="funexploit#gmail.com">funexploit # gmail.com</a></p>
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id24">开发环境搭建</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">kermit</p>
<p>创建kermit配置文件/root/.kermrc</p>
<div class="highlight-python"><div class="highlight"><pre>set line /dev/ttyUSB0
set speed 115200
set carrier-watch off
set handshake none
set flow-control none
robust
set file type bin
set file name lit
set rec pack 1000
set send pack 1000
set window 5
c
</pre></div>
</div>
</li>
<li><p class="first">tftp服务</p>
</li>
<li><p class="first">nfs服务</p>
</li>
<li><p class="first">u-boot设置</p>
</li>
</ul>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id25">根文件系统构建</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="section" id="busybox">
<h4><a class="toc-backref" href="#id26">busybox</a><a class="headerlink" href="#busybox" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p class="first">make defconfig</p>
</li>
<li><p class="first">修改 .config 文件中两个地方</p>
<p># 编译器前缀
CONFIG_CROSS_COMPILER_PREFIX=&#8221;arm-linux-&#8220;</p>
<p># 安装路径，指定为NFS挂载的rootfs根目录
CONFIG_PREFIX=&#8221;./_install&#8221;</p>
</li>
<li><p class="first">make</p>
</li>
<li><p class="first">make install</p>
</li>
</ol>
</div>
<div class="section" id="id3">
<h4><a class="toc-backref" href="#id27">根文件系统其它必须文件</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><div class="highlight"><pre>mkdir dev etc mnt proc root sys tmp
</pre></div>
</div>
<p>参考 busybox/docs/mdev.txt 构建 /dev 。</p>
<ul>
<li><p class="first">/etc/inittab</p>
<p>参考 busybox/examples/inittab</p>
<p>将其中的 &#8221;::askfirst:-/bin/sh&#8221; 改为 &#8220;ttySAC0::askfirst:-/bin/sh&#8221; ，以便在串口上输出。</p>
</li>
<li><p class="first">/etc/init.d/rcS</p>
<div class="highlight-python"><div class="highlight"><pre>ifconfig eth0 192.168.2.102
mount -a
mkdir /dev/pts
mount -t devpts devpts /dev/pts
echo /sbin/mdev &gt; /proc/sys/kernel/hotplug
mdev -s
</pre></div>
</div>
<p>然后需要开启执行权限</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">rcS</span>
</pre></div>
</div>
</li>
<li><p class="first">/etc/fatab</p>
<div class="highlight-python"><div class="highlight"><pre>proc    /proc   proc    defaults        0       0
tmpfs   /tmp    tmpfs   defaults        0       0
sysfs   /sys    sysfs   defaults        0       0
tmpfs   /dev    tmpfs   defaults        0       0
</pre></div>
</div>
</li>
<li><p class="first">/etc/mdev.conf</p>
<p>参考 busybox/examples/mdev.conf</p>
</li>
</ul>
</div>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id28">遇到的疑难杂症</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">使用下载的交叉编译工具，运行时提示&#8221;No such file or directory&#8221;</p>
<p>由于使用的是64位的系统，而下载的是32位的，需要安装几个库文件</p>
<div class="highlight-python"><div class="highlight"><pre>aptitude install lib32ncurses5 lib32z1 lib32bz2-1.0
</pre></div>
</div>
</li>
<li><p class="first">通过NFS挂载根系统时，提示&#8221;can&#8217;t open /r/dev/console: no such file&#8221;</p>
<p>禁用内核中下面的选项即可</p>
<div class="highlight-python"><div class="highlight"><pre>CONFIG_BLK_DEV_INITRD:

The initial RAM filesystem is a ramfs which is loaded by the
boot loader (loadlin or lilo) and that is mounted as root
before the normal boot procedure. It is typically used to
load modules needed to mount the &quot;real&quot; root file system,
etc. See &lt;file:Documentation/initrd.txt&gt; for details.

If RAM disk support (BLK_DEV_RAM) is also included, this
also enables initial RAM disk (initrd) support and adds
15 Kbytes (more on some other architectures) to the kernel size.

If unsure say Y.

Symbol: BLK_DEV_INITRD [=n]
Type  : boolean
Prompt: Initial RAM filesystem and RAM disk (initramfs/initrd) support
  Defined at init/Kconfig:865
  Depends on: BROKEN [=n] || !FRV
  Location:
    -&gt; General setup
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="id5">
<h2><a class="toc-backref" href="#id29">概述</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id30">驱动底层封装接口</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>内核中有很多函数，封装了对底层寄存器的操作。</p>
<ul>
<li><p class="first">arch/arm/plat-samsung/include/plat/gpio-cfg.h</p>
<p>s3c_gpio_cfgpin()</p>
<p>s3c_irq_eint_set_type</p>
</li>
<li><p class="first">include/linux/gpio.h</p>
<ul class="simple">
<li>gpio_direction_input()</li>
<li>gpio_direction_output()</li>
</ul>
</li>
<li><p class="first">arch/arm/mach-s3c64xx/include/mach/gpio.h</p>
<p>寄存器不需要自己一个一个去remap()，内核中已经有现成的包装好的接口，例如 <tt class="docutils literal"><span class="pre">S3C64XX_GPN(0)</span></tt></p>
<ul class="simple">
<li>gpio_get_value()</li>
<li>gpio_set_value()</li>
<li>gpio_cansleep()</li>
<li>gpio_to_irq()</li>
</ul>
</li>
</ul>
<p>参考</p>
<blockquote>
<div><a class="reference external" href="http://blog.sina.com.cn/s/blog_3c70fb610100mufi.html">http://blog.sina.com.cn/s/blog_3c70fb610100mufi.html</a></div></blockquote>
</div>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id31">驱动程序结构</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">file_operations</p>
</li>
<li><p class="first">devno</p>
<p>alloc_chrdev_region
unregister_chrdev_region</p>
</li>
<li><p class="first">cdev</p>
<p>cdev_init
cdev_add
cdev_del</p>
</li>
<li><p class="first">class, device</p>
<p>class_create
class_destroy
device_create
device_destroy</p>
</li>
</ul>
</div>
<div class="section" id="id8">
<h3><a class="toc-backref" href="#id32">主要文件介绍</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">/linux-3.10/arch/arm/plat-samsung/</p>
<p>三星SoC系统的公用代码</p>
</li>
<li><p class="first">/linux-3.10/arch/arm/mach-s3c64xx/</p>
<p>三星64xx系列SoC开发板的代码</p>
</li>
<li><p class="first">/linux-3.10/arch/arm/mach-s3c64xx/s3c6410.c</p>
<p>定义s3c6410 CPU通用的一些资源和函数，供./common.c使用</p>
<div class="highlight-python"><div class="highlight"><pre>static struct cpu_table cpu_ids[] __initdata = {
    {
        .idcode             = S3C6400_CPU_ID,
        .idmask             = S3C64XX_CPU_MASK,
        .map_io             = s3c6400_map_io,
        .init_clocks        = s3c6400_init_clocks,
        .init_uarts = s3c64xx_init_uarts,
        .init               = s3c6400_init,
        .name               = name_s3c6400,
    }, {
        .idcode             = S3C6410_CPU_ID,
        .idmask             = S3C64XX_CPU_MASK,
        .map_io             = s3c6410_map_io,
        .init_clocks        = s3c6410_init_clocks,
        .init_uarts = s3c64xx_init_uarts,
        .init               = s3c6410_init,
        .name               = name_s3c6410,
    },
};
</pre></div>
</div>
</li>
<li><p class="first">/linux-3.10/arch/arm/mach-s3c64xx/common.c</p>
<p>定义s3c64xx开发板通用的一些资源和函数，供具体的板级文件使用，例如./mach-mini6410.c</p>
</li>
<li><p class="first">/linux-3.10/arch/arm/mach-s3c64xx/mach-mini6410.c</p>
<p>定义板级文件相关内容，包括主要的外设资源，以及开发板初始化等一些列操作，最后通过MACHINE_START和MACHINE_END宏将其定义到一个struct machine_desc结构中</p>
<div class="highlight-python"><div class="highlight"><pre>MACHINE_START(MINI6410, &quot;MINI6410&quot;)
    /* Maintainer: Darius Augulis &lt;augulis.darius@gmail.com&gt; */
    .atag_offset    = 0x100,
    .init_irq       = s3c6410_init_irq,
    .map_io         = mini6410_map_io,
    .init_machine   = mini6410_machine_init,
    .init_late      = s3c64xx_init_late,
    .init_time      = samsung_timer_init,
    .restart        = s3c64xx_restart,
MACHINE_END
</pre></div>
</div>
<ul>
<li><p class="first">platform设备</p>
<p>在此文件中定义了一个platform_device的数组</p>
<div class="highlight-python"><div class="highlight"><pre>static struct platform_device *mini6410_devices[] __initdata = {
    &amp;mini6410_device_eth,
    &amp;s3c_device_hsmmc0,
    &amp;s3c_device_hsmmc1,
    &amp;s3c_device_ohci,
    &amp;s3c_device_nand,
    &amp;s3c_device_fb,
    &amp;mini6410_lcd_powerdev,
    &amp;s3c_device_adc,
    &amp;s3c_device_ts,
};
</pre></div>
</div>
</li>
</ul>
<blockquote>
<div><p>随后，在mini6410_machine_init()中将这些platform设备加入</p>
<div class="highlight-python"><div class="highlight"><pre>static void __init mini6410_machine_init(void)
{
    ...

    platform_add_devices(mini6410_devices, ARRAY_SIZE(mini6410_devices));
}
</pre></div>
</div>
</div></blockquote>
<ul>
<li><p class="first">Nand Flash</p>
<p>Nand Flash分区信息</p>
<div class="highlight-python"><div class="highlight"><pre>static struct mtd_partition mini6410_nand_part[] = {
    [0] = {
        .name     = &quot;uboot&quot;,
        .size     = SZ_1M,
        .offset   = 0,
    },
    [1] = {
        .name     = &quot;kernel&quot;,
        .size     = SZ_2M,
        .offset   = SZ_1M,
    },
    [2] = {
        .name     = &quot;rootfs&quot;,
        .size     = MTDPART_SIZ_FULL,
        .offset   = SZ_1M + SZ_2M,
    },
};
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id33">其他</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>module_driver(__driver, __register, __unregister, ...)</p>
</div>
<div class="section" id="id10">
<h3><a class="toc-backref" href="#id34">应用层辅助工具</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>fbset
sysfsutils
mtd-utils
usbutils</p>
</div>
</div>
<div class="section" id="id11">
<h2><a class="toc-backref" href="#id35">设备驱动模型及子系统</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<div class="section" id="bus-device-driver">
<h3><a class="toc-backref" href="#id36">bus-device-driver 设备驱动模型</a><a class="headerlink" href="#bus-device-driver" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="platform">
<h3><a class="toc-backref" href="#id37">Platform 虚拟总线</a><a class="headerlink" href="#platform" title="Permalink to this headline">¶</a></h3>
<p>6410中的platform驱动包括：I2C、LCD、看门狗等</p>
<p>主要的数据结构</p>
<p>struct platform_device</p>
<blockquote>
<div>包括设备名、资源等信息</div></blockquote>
<p>struct platform_driver</p>
<blockquote>
<div><p>包括各种操作，例如probe remove等</p>
<div class="highlight-python"><div class="highlight"><pre>int platform_device_add(struct platform_device *pdev)
void platform_device_del(struct platform_device *pdev)
int platform_device_register(struct platform_device *pdev)
void platform_device_unregister(struct platform_device *pdev)
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="id12">
<h3><a class="toc-backref" href="#id38">输入子系统</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="framebuffer">
<h3><a class="toc-backref" href="#id39">视频子系统(framebuffer)</a><a class="headerlink" href="#framebuffer" title="Permalink to this headline">¶</a></h3>
<p>参考：Documentation/fb/framebuffer.txt</p>
<p>物理显示设备的工作原理如下：显示屏可以看作由一个一个像素组成，在显示的时候可以理解为向某个像素绘制某种颜色，整个屏幕的绘制顺序是从左到右，然后移动到下一行的行首，如此往复。绘制完整个屏幕之后，会跳回到屏幕的左上角。从上一行的行尾到下一行的行首所需时间被称为(horizontal retrace)，绘制完一屏后，从屏的右下角到左上角所需时间被称为(vertical retrace)。</p>
<p>屏幕的横纵分辨率分别被称为xres和yres。物理设备绘制的大小比实际的屏幕大，多出来的部分上下左右分别被称为upper margin, lower margin,left margin和right margin。另外，显示器并不知道什么时候开始一个新行，而是由一个行同步脉冲(horizontal sync或者简称为hsync)告诉它何时开始新行，hsync持续时间称为hsync len。同理，由列同步脉冲(vertical sync或者简称为vsync)告诉它何时从左上角开始绘制一个新屏(frame)，vsync持续时间称为vsync len。</p>
<img alt="../images/driver_framebuffer.png" src="../images/driver_framebuffer.png" />
<p>从上图可以看出</p>
<div class="highlight-python"><div class="highlight"><pre>horizontal retrace = left margin  + right margin + hsync len
vertical   retrace = upper margin + lower margin + vsync len
</pre></div>
</div>
<p>在编写驱动程序时，最主要的工作之一就是配置显示设备的物理参数，可以使用用户层命令fbset获得。</p>
<div class="highlight-python"><div class="highlight"><pre>mode &quot;480x272-501595&quot;
    # D: 76923.077 MHz, H: 145964.093 kHz, V: 501594.821 Hz
    geometry 480 272 480 272 16
    timings 13 40 5 9 8 2 2
    accel false
    rgba 5/11,6/5,5/0,0/0
endmode
</pre></div>
</div>
<p>绘制每个像素的时间称为dotclock(单位是ps，即 picoseconds，1 s = 10^12 ps)。</p>
<p>在fbset命令的输出中D、H、V代表分别绘制一个像素、一行和一屏的频率。</p>
<p>geometry行分别表示可视水平分辨率(visible horizontal resolution，即xres)、可视垂直分辨率(visible vertical resolution，即yres)、虚拟水平分辨率(virtual horizontal resolution)、虚拟垂直分辨率(virtual vertical resolution)，以及颜色深度值，即每个像素需要几bit来表示。</p>
<p>timings行分别表示dotclock, left margin, right margin, upper margin, lower margin, hsync len 和 vsync len，单位是ps。</p>
<p>可以使用上面的知识，由geometry和timings的内容计算出D、H和V的值，验证fbset的输出，计算过程如下</p>
<div class="highlight-python"><div class="highlight"><pre>D = 1 / dotclock
  = 1 / (13 ps)
  = 76923.0769 MHz

H = 1 / (dotclock * (xres + horizontal retrace))
  = 1 / (dotclock * (xres + left_margin + right_margin + hsync+len))
  = 1 / (dotclock * (480  + 40          + 5            + 2        ))
  = 1 / (13 ps    * 527 pixels)
  = 145964.093 KHz

V = 1 / (dotclock * (xres + horizontal retrace) * (yres + vertical retrace))
  = 1 / (dotclock * (xres + left_margin  + right_margin + hsync+len)
                  * (yres + upper_margin + lower_margin + vsync+len))
  = 1 / (dotclock * (480  + 40           + 5            + 2)
                  * (272  + 9            + 8            + 2))
  = 1 / (13 ps * (527 * 291) pixel)
  = 501594.821 Hz
</pre></div>
</div>
</div>
</div>
<div class="section" id="id13">
<h2><a class="toc-backref" href="#id40">内核机制</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id14">
<h3><a class="toc-backref" href="#id41">并发控制( 信号量、自旋锁)</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="id15">
<h3><a class="toc-backref" href="#id42">内核定时器</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="id16">
<h3><a class="toc-backref" href="#id43">休眠与唤醒</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="id17">
<h3><a class="toc-backref" href="#id44">中断</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">include/linux/interrupt.h</p>
<ul>
<li><p class="first">注册中断、释放中断</p>
<div class="highlight-python"><div class="highlight"><pre>request_irq(unsigned int irq, irq_handler_t handler, unsigned long flags,
        const char *name, void *dev);

void free_irq(unsigned int, void *);
</pre></div>
</div>
</li>
<li><p class="first">触发方式：上升沿、下降沿、高电平、低电平</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#define IRQF_TRIGGER_RISING       0x00000001</span>
<span class="c">#define IRQF_TRIGGER_FALLING      0x00000002</span>
<span class="c">#define IRQF_TRIGGER_HIGH 0x00000004</span>
<span class="c">#define IRQF_TRIGGER_LOW  0x00000008</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id18">
<h3><a class="toc-backref" href="#id45">异步通知</a><a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h3>
<p>驱动测试程序需要做的：</p>
<ol class="arabic simple">
<li>将当前进程设置为设备文件的&#8221;属主&#8221;进程。通过使用fcntl的F_SETOWN参数设置，将进程号保存在filp-&gt;f_owner中。</li>
<li>针对打开的驱动的设备文件，设置FASYNC标志。</li>
</ol>
<p>驱动程序需要做的：</p>
<ol class="arabic simple">
<li>在驱动测试程序设置F_SETOWN时，对filp-&gt;f_owner赋值。这一步会自动完成，驱动中不需要添加额外的代码。</li>
<li>实现struct file_operations中的fasync调用，在fasync函数中通过内核提供的fasync_helper()来响应测试程序设置的FASYNC标志。</li>
<li>数据达到时，使用kill_fasync()，向注册的&#8221;属主&#8221;进程发送SIGIO信号。</li>
<li>在struct file_operations的release函数中，明确使用.fasync(-1, filp, 0)从异步通知列表中移除filp。</li>
</ol>
</div>
</div>
<div class="section" id="id19">
<h2><a class="toc-backref" href="#id46">硬件设备驱动程序开发</a><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id20">
<h3><a class="toc-backref" href="#id47">串口</a><a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id21">
<h4><a class="toc-backref" href="#id48">主要的数据结构</a><a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">uart driver</p>
<div class="highlight-python"><div class="highlight"><pre>struct uart_driver
int uart_register_driver(struct uart_driver *uart);
void uart_unregister_driver(struct uart_driver *uart);
</pre></div>
</div>
</li>
<li><p class="first">uart port</p>
<div class="highlight-python"><div class="highlight"><pre>struct uart_port
int uart_add_one_port(struct uart_driver *reg, struct uart_port *port);
int uart_remove_one_port(struct uart_driver *reg, struct uart_port *port);
</pre></div>
</div>
</li>
<li><p class="first">uart ops</p>
<div class="highlight-python"><div class="highlight"><pre>struct uart_ops
</pre></div>
</div>
</li>
<li><p class="first">console</p>
<div class="highlight-python"><div class="highlight"><pre>struct console
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="id22">
<h4><a class="toc-backref" href="#id49">主要的操作</a><a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h4>
<p>定义在struct uart_ops中</p>
<div class="highlight-python"><div class="highlight"><pre>/*
 * This structure describes all the operations that can be done on the
 * physical hardware.  See Documentation/serial/driver for details.
 */
struct uart_ops {
      unsigned int    (*tx_empty)(struct uart_port *);
      void            (*set_mctrl)(struct uart_port *, unsigned int mctrl);
      unsigned int    (*get_mctrl)(struct uart_port *);
      void            (*stop_tx)(struct uart_port *);
      void            (*start_tx)(struct uart_port *);
      void            (*throttle)(struct uart_port *);
      void            (*unthrottle)(struct uart_port *);
      void            (*send_xchar)(struct uart_port *, char ch);
      void            (*stop_rx)(struct uart_port *);
      void            (*enable_ms)(struct uart_port *);
      void            (*break_ctl)(struct uart_port *, int ctl);
      int             (*startup)(struct uart_port *);
      void            (*shutdown)(struct uart_port *);
      void            (*flush_buffer)(struct uart_port *);
      void            (*set_termios)(struct uart_port *, struct ktermios *new,
                                     struct ktermios *old);
      void            (*set_ldisc)(struct uart_port *, int new);
      void            (*pm)(struct uart_port *, unsigned int state,
                            unsigned int oldstate);
      int             (*set_wake)(struct uart_port *, unsigned int state);

      /*
       * Return a string describing the type of the port
       */
      const char      *(*type)(struct uart_port *);

      /*
       * Release IO and memory resources used by the port.
       * This includes iounmap if necessary.
       */
      void            (*release_port)(struct uart_port *);

      /*
       * Request IO and memory resources used by the port.
       * This includes iomapping the port if necessary.
       */
      int             (*request_port)(struct uart_port *);
      void            (*config_port)(struct uart_port *, int);
      int             (*verify_port)(struct uart_port *, struct serial_struct *);
      int             (*ioctl)(struct uart_port *, unsigned int, unsigned long);
#ifdef CONFIG_CONSOLE_POLL
      int             (*poll_init)(struct uart_port *);
      void            (*poll_put_char)(struct uart_port *, unsigned char);
      int             (*poll_get_char)(struct uart_port *);
#endif
};
</pre></div>
</div>
<ul>
<li><p class="first">数据发送</p>
<p>数据保存在struct circ_buf中</p>
<ul class="simple">
<li>pull模式</li>
<li>利用中断的数据发送</li>
</ul>
</li>
<li><p class="first">数据接收</p>
</li>
<li><p class="first">modem控制线</p>
</li>
<li><p class="first">termios</p>
</li>
<li><p class="first">console</p>
</li>
</ul>
</div>
</div>
<div class="section" id="nand-flash">
<h3><a class="toc-backref" href="#id50">Nand Flash</a><a class="headerlink" href="#nand-flash" title="Permalink to this headline">¶</a></h3>
<p>struct mtd_part</p>
<blockquote>
<div>表示分区信息</div></blockquote>
<p>add_mtd_partitions()
del_mtd_partitions()</p>
<p>add_mtd_device()
del_mtd_device()</p>
</div>
<div class="section" id="usb">
<h3><a class="toc-backref" href="#id51">USB</a><a class="headerlink" href="#usb" title="Permalink to this headline">¶</a></h3>
<p>struct usb_string_descriptor
struct usb_endpoint_descriptor
struct usb_interface_descriptor
struct usb_config_descriptor
struct usb_device_descriptor</p>
<p>struct usb_hcd
struct hc_driver</p>
</div>
<div class="section" id="network">
<h3><a class="toc-backref" href="#id52">Network</a><a class="headerlink" href="#network" title="Permalink to this headline">¶</a></h3>
<div class="section" id="lcd">
<h4><a class="toc-backref" href="#id53">LCD硬件相关</a><a class="headerlink" href="#lcd" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">信号</p>
<p>VSYNC         垂直方向同步信号(vertical sync)
HSYNC         水平方向同步信号(horizontal sync)
VDEN          (video data enable)
VCLK          时钟信号(video clock)
LED+、LED-    背光信号
VD0-VD23      RGB信号(video data)</p>
</li>
<li><p class="first">配置</p>
<p>bpp(bit per pixel)</p>
</li>
</ul>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">linux驱动开发笔记</a><ul>
<li><a class="reference internal" href="#id1">开发环境搭建</a><ul>
<li><a class="reference internal" href="#id2">根文件系统构建</a><ul>
<li><a class="reference internal" href="#busybox">busybox</a></li>
<li><a class="reference internal" href="#id3">根文件系统其它必须文件</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id4">遇到的疑难杂症</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id5">概述</a><ul>
<li><a class="reference internal" href="#id6">驱动底层封装接口</a></li>
<li><a class="reference internal" href="#id7">驱动程序结构</a></li>
<li><a class="reference internal" href="#id8">主要文件介绍</a></li>
<li><a class="reference internal" href="#id9">其他</a></li>
<li><a class="reference internal" href="#id10">应用层辅助工具</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id11">设备驱动模型及子系统</a><ul>
<li><a class="reference internal" href="#bus-device-driver">bus-device-driver 设备驱动模型</a></li>
<li><a class="reference internal" href="#platform">Platform 虚拟总线</a></li>
<li><a class="reference internal" href="#id12">输入子系统</a></li>
<li><a class="reference internal" href="#framebuffer">视频子系统(framebuffer)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id13">内核机制</a><ul>
<li><a class="reference internal" href="#id14">并发控制( 信号量、自旋锁)</a></li>
<li><a class="reference internal" href="#id15">内核定时器</a></li>
<li><a class="reference internal" href="#id16">休眠与唤醒</a></li>
<li><a class="reference internal" href="#id17">中断</a></li>
<li><a class="reference internal" href="#id18">异步通知</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id19">硬件设备驱动程序开发</a><ul>
<li><a class="reference internal" href="#id20">串口</a><ul>
<li><a class="reference internal" href="#id21">主要的数据结构</a></li>
<li><a class="reference internal" href="#id22">主要的操作</a></li>
</ul>
</li>
<li><a class="reference internal" href="#nand-flash">Nand Flash</a></li>
<li><a class="reference internal" href="#usb">USB</a></li>
<li><a class="reference internal" href="#network">Network</a><ul>
<li><a class="reference internal" href="#lcd">LCD硬件相关</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/sources/driver.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../index.html">funexploit 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, jff.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>